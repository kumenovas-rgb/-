mport cv2
import mediapipe as mp
import random
import time

# Инициализация MediaPipe для распознавания рук
mp_hands = mp.solutions.hands
hands = mp_hands.Hands(max_num_hands=1, min_detection_confidence=0.7)
mp_draw = mp.solutions.drawing_utils

def get_gesture(landmarks):
    # Логика определения жеста по точкам руки
    fingers = []
    # Кончики пальцев (кроме большого)
    tip_ids = [8, 12, 16, 20]
    
    # Проверка: поднят палец или согнут
    for tip in tip_ids:
        if landmarks[tip].y < landmarks[tip - 2].y:
            fingers.append(1)
        else:
            fingers.append(0)
            
    # Считаем результат
    total_fingers = sum(fingers)
    if total_fingers == 0: return "Rock"
    if total_fingers == 2: return "Scissors"
    if total_fingers >= 3: return "Paper"
    return "Unknown"

cap = cv2.VideoCapture(0)
computer_move = "None"
result = "Show your hand!"
last_move_time = 0

while cap.isOpened():
    success, img = cap.read()
    if not success: break

    img = cv2.flip(img, 1)
    img_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    process_result = hands.process(img_rgb)
    
    if process_result.multi_hand_landmarks:
        for hand_lms in process_result.multi_hand_landmarks:
            mp_draw.draw_landmarks(img, hand_lms, mp_hands.HAND_CONNECTIONS)
            
            # Распознаем жест игрока
            player_move = get_gesture(hand_lms.landmark)
            
            # Если жест определен и прошло 2 секунды с прошлого хода
            if player_move != "Unknown" and (time.time() - last_move_time) > 3:
                computer_move = random.choice(["Rock", "Paper", "Scissors"])
                last_move_time = time.time()
                
                # Логика победы
                if player_move == computer_move:
                    result = "Draw!"
                elif (player_move == "Rock" and computer_move == "Scissors") or \
                     (player_move == "Scissors" and computer_move == "Paper") or \
                     (player_move == "Paper" and computer_move == "Rock"):
                    result = f"You Win! ({player_move} vs {computer_move})"
                else:
                    result = f"Computer Wins! ({computer_move} vs {player_move})"

    # Вывод текста на экран (как в Scratch)
    cv2.putText(img, f"Result: {result}", (10, 50), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)
    cv2.imshow("Rock Paper Scissors AI", img)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
